name: Release (Official GitHub CLI)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # gh 需要这个权限来创建 release

env:
  BINARY_NAME: myapp

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - name: Set up Go
        uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568 # v3.5.0
        with:
          go-version-file: 'go.mod'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          mkdir -p artifacts
          
          echo "Building all cmd/* for ${GOOS}/${GOARCH}..."
          for d in cmd/* ; do
            if [ -d "$d" ]; then
              name=$(basename "$d")
              OUTPUT_NAME="${name}-${{ steps.version.outputs.VERSION }}-${GOOS}-${GOARCH}"
              echo "  - Building ${OUTPUT_NAME} from ${d}..."
              GOOS="${GOOS}" GOARCH="${GOARCH}" CGO_ENABLED=0 \
                go build -ldflags="-s -w -X 'main.Version=${{ steps.version.outputs.VERSION }}'" \
                -o "artifacts/${OUTPUT_NAME}" "./${d}"
              sha256sum "artifacts/${OUTPUT_NAME}" > "artifacts/${OUTPUT_NAME}.sha256"
            fi
          done
          
          echo "✅ Build complete for ${GOOS}/${GOARCH}"

      - name: Upload artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: artifacts/${{ env.BINARY_NAME }}*
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
        with:
          fetch-depth: 0  # 需要完整历史来生成 release notes

      - name: Download all artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: ./artifacts
          pattern: '${{ env.BINARY_NAME }}-*'
          merge-multiple: true

      - name: Display downloaded files
        run: |
          echo "Downloaded files:"
          ls -lh ./artifacts/

      - name: Create Release using GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # バージョン番号を抽出
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Creating release for ${VERSION}..."
          
          # プレリリース版かどうかを判定
          PRERELEASE=""
          if [[ "$VERSION" == *"rc"* ]]; then
            PRERELEASE="--prerelease"
            echo "This is a pre-release version"
          fi
          
          # リリースノートを作成（例：各 cmd のバイナリ名は <cmd>-${VERSION}-<os>-<arch> になります）
          cat > release-notes.md << EOF
          ## インストール方法
          
          各コマンドバイナリは次の形式でリリースアセットに含まれます:
          \`<cmd>-${VERSION}-linux-amd64\` や \`<cmd>-${VERSION}-linux-arm64\` のようになります。
          
          例（<cmd> を実際のコマンド名に置き換えてください）:
          - **Linux (x64)**: \`<cmd>-${VERSION}-linux-amd64\`
          - **Linux (ARM64)**: \`<cmd>-${VERSION}-linux-arm64\`
          
          ### インストール手順（例）
          \`\`\`bash
          # ファイルをダウンロード（<cmd> を実際のコマンド名に置き換える）
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/<cmd>-${VERSION}-linux-amd64
          
          # チェックサムを検証 (推奨)
          wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/<cmd>-${VERSION}-linux-amd64.sha256
          sha256sum -c <cmd>-${VERSION}-linux-amd64.sha256
          
          # 実行権限を付与
          chmod +x <cmd>-${VERSION}-linux-amd64
          
          # システムパスに移動 (オプション)
          sudo mv <cmd>-${VERSION}-linux-amd64 /usr/local/bin/<cmd>
          \`\`\`
          EOF
          
          # リリースを作成
          gh release create "$VERSION" \
            ./artifacts/* \
            --title "Release ${VERSION}" \
            --notes-file release-notes.md \
            --generate-notes \
            $PRERELEASE
          
          echo "✅ Release ${VERSION} created successfully!"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/${VERSION}"